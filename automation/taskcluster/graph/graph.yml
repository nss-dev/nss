templates:
  ## Base Definitions #########################################################

  builder:
    artifact: "dist.tar.bz2"
    command:
      - "/bin/bash"
      - "-c"
      - "bin/checkout.sh && nss/automation/taskcluster/scripts/build.sh"
    env:
      NSS_ENABLE_TLS_1_3: 1
      GCC_VERSION: gcc-5
      GXX_VERSION: g++-5
    treeherder:
      symbol: B

  builder_no_tests:
    extends: builder
    treeherder:
      groupSymbol: Builds
      groupName: Various builds

  builder_gcc4:
    extends: builder_no_tests
    env:
      GCC_VERSION: gcc-4.8
      GXX_VERSION: g++-4.8
    treeherder:
      symbol: gcc-4.8

  builder_gcc6:
    extends: builder_no_tests
    env:
      GCC_VERSION: gcc-6
      GXX_VERSION: g++-6
    treeherder:
      symbol: gcc-6.1

  builder_clang:
    extends: builder_no_tests
    env:
      GCC_VERSION: clang-3.8
      GXX_VERSION: clang++-3.8
    treeherder:
      symbol: clang-3.8

  builder_no_pkcs11_bypass:
    extends: builder_no_tests
    env:
      NO_PKCS11_BYPASS: 1
    treeherder:
      symbol: noPkcs11Bypass

  builder_no_tls_1_3:
    extends: builder_no_tests
    env:
      NSS_ENABLE_TLS_1_3: ""
    treeherder:
      symbol: noTLSv1.3

  builder_with_tests:
    extends: builder
    subtasks:
      cert: true
      chains: true
      cipher: true
      crmf: true
      dbtests: true
      ec: true
      fips: true
      gtests: true
      libpkix: true
      lowhash: true
      merge: true
      ocsp: true
      pkits: true
      sdr: true
      smime: true
      ssl: true
      tools: true

  test_runner:
    command:
      - "/bin/bash"
      - "-c"
      - "bin/checkout.sh && nss/automation/taskcluster/scripts/run_tests.sh"

  memleak:
    extends: test_runner
    env:
      NSS_TESTS: "memleak"
    treeherder:
      groupSymbol: MemLeak
      groupName: MemLeak tests

  ## Test Definitions #########################################################

  cert:
    name: "Cert tests"
    extends: test_runner
    env:
      NSS_TESTS: "cert"
    treeherder:
      symbol: Cert

  chains:
    name: "Chains tests"
    extends: test_runner
    env:
      NSS_TESTS: "chains"
    treeherder:
      symbol: Chains

  cipher:
    name: "Cipher tests"
    extends: test_runner
    env:
      NSS_TESTS: "cipher"
    treeherder:
      symbol: Cipher

  crmf:
    name: "CRMF tests"
    extends: test_runner
    env:
      NSS_TESTS: "crmf"
    treeherder:
      symbol: CRMF

  dbtests:
    name: "DB tests"
    extends: test_runner
    env:
      NSS_TESTS: "dbtests"
    treeherder:
      symbol: DB

  ec:
    name: "EC tests"
    extends: test_runner
    env:
      NSS_TESTS: "ec"
    treeherder:
      symbol: EC

  fips:
    name: "FIPS tests"
    extends: test_runner
    env:
      NSS_TESTS: "fips"
    treeherder:
      symbol: FIPS

  gtests:
    name: "GTests"
    extends: test_runner
    env:
      NSS_TESTS: "ssl_gtests gtests"
    treeherder:
      symbol: GTest

  libpkix:
    name: "libpkix tests"
    extends: test_runner
    env:
      NSS_TESTS: "libpkix"
    treeherder:
      symbol: PKIX

  lowhash:
    name: "lowhash tests"
    extends: test_runner
    env:
      NSS_TESTS: "lowhash"
    treeherder:
      symbol: Lowhash

  memleak_server:
    name: "MemLeak tests (ssl_server)"
    extends: memleak
    env:
      NSS_MEMLEAK_TESTS: "ssl_server"
    treeherder:
      symbol: server

  memleak_client:
    name: "MemLeak tests (ssl_client)"
    extends: memleak
    env:
      NSS_MEMLEAK_TESTS: "ssl_client"
    treeherder:
      symbol: client

  memleak_chains:
    name: "MemLeak tests (chains)"
    extends: memleak
    env:
      NSS_MEMLEAK_TESTS: "chains"
    treeherder:
      symbol: chains

  memleak_ocsp:
    name: "MemLeak tests (ocsp)"
    extends: memleak
    env:
      NSS_MEMLEAK_TESTS: "ocsp"
    treeherder:
      symbol: ocsp

  merge:
    name: "Merge tests"
    extends: test_runner
    env:
      NSS_TESTS: "merge"
    treeherder:
      symbol: Merge

  ocsp:
    name: "OCSP tests"
    extends: test_runner
    env:
      NSS_TESTS: "ocsp"
    treeherder:
      symbol: OCSP

  pkits:
    name: "NIST PKITS tests"
    extends: test_runner
    env:
      NSS_TESTS: "pkits"
    treeherder:
      symbol: PKITS

  sdr:
    name: "SDR tests"
    extends: test_runner
    env:
      NSS_TESTS: "sdr"
    treeherder:
      symbol: SDR

  smime:
    name: "S/MIME tests"
    extends: test_runner
    env:
      NSS_TESTS: "smime"
    treeherder:
      symbol: SMIME

  ssl: # Update this when TLS v1.3 doesn't fail these anymore.
    name: "SSL tests"
    artifact: "dist.tar.bz2"
    command:
      - "/bin/bash"
      - "-c"
      - "bin/checkout.sh && nss/automation/taskcluster/scripts/build.sh"
    env:
      NSS_ENABLE_TLS_1_3: "" # Remove this.
      NSS_TESTS: "ssl"
    treeherder:
      groupSymbol: SSL
      groupName: SSL tests
    subtasks:
      ssl_standard: true
      ssl_pkix: true
      ssl_upgradedb: true
      ssl_sharedb: true

  ssl_standard:
    name: "SSL tests (standard)"
    extends: test_runner
    env:
      NSS_CYCLES: "standard"
    treeherder:
      symbol: "standard"
  ssl_pkix:
    name: "SSL tests (pkix)"
    extends: test_runner
    env:
      NSS_CYCLES: "pkix"
    treeherder:
      symbol: "pkix"
  ssl_upgradedb:
    name: "SSL tests (upgradedb)"
    extends: test_runner
    env:
      NSS_CYCLES: "upgradedb"
    treeherder:
      symbol: "upgradedb"
  ssl_sharedb:
    name: "SSL tests (sharedb)"
    extends: test_runner
    env:
      NSS_CYCLES: "sharedb"
    treeherder:
      symbol: "sharedb"

  tools:
    name: "Tools tests"
    extends: test_runner
    env:
      NSS_TESTS: "tools"
    treeherder:
      symbol: Tools

## Task Graph #################################################################

graph:
  build-32-debug:
    name: "Linux 32 (debug)"
    extends: builder_with_tests
    treeherder:
      build:
        platform: linux32
      collection:
        debug: true

  build-32-opt:
    name: "Linux 32 (opt)"
    extends: builder_with_tests
    env:
      BUILD_OPT: 1
    treeherder:
      build:
        platform: linux32
      collection:
        opt: true

  build-64-debug:
    name: "Linux 64 (debug)"
    extends: builder_with_tests
    env:
      USE_64: 1
    treeherder:
      build:
        platform: linux64
      collection:
        debug: true
    subtasks:
      memleak_server: true
      memleak_client: true
      memleak_chains: true
      memleak_ocsp: true

  build-64-asan:
    name: "Linux 64 (ASan)"
    extends: builder_with_tests
    env:
      USE_ASAN: 1
      USE_64: 1
    treeherder:
      build:
        platform: linux64
      collection:
        asan: true

  build-64-opt:
    name: "Linux 64 (opt)"
    extends: builder_with_tests
    env:
      BUILD_OPT: 1
      USE_64: 1
    treeherder:
      build:
        platform: linux64
      collection:
        opt: true

  ## GCC 4 ####################################################################

  build-32-debug-gcc4:
    name: "Linux 32 (debug, gcc4)"
    extends: builder_gcc4
    treeherder:
      build:
        platform: linux32
      collection:
        debug: true

  build-32-opt-gcc4:
    name: "Linux 32 (opt, gcc4)"
    extends: builder_gcc4
    env:
      BUILD_OPT: 1
    treeherder:
      build:
        platform: linux32
      collection:
        opt: true

  build-64-debug-gcc4:
    name: "Linux 64 (debug, gcc4)"
    extends: builder_gcc4
    env:
      USE_64: 1
    treeherder:
      build:
        platform: linux64
      collection:
        debug: true

  build-64-opt-gcc4:
    name: "Linux 64 (opt, gcc4)"
    extends: builder_gcc4
    env:
      BUILD_OPT: 1
      USE_64: 1
    treeherder:
      build:
        platform: linux64
      collection:
        opt: true

  ## GCC 6 ####################################################################

  build-32-debug-gcc6:
    name: "Linux 32 (debug, gcc6)"
    extends: builder_gcc6
    treeherder:
      build:
        platform: linux32
      collection:
        debug: true

  build-32-opt-gcc6:
    name: "Linux 32 (opt, gcc6)"
    extends: builder_gcc6
    env:
      BUILD_OPT: 1
    treeherder:
      build:
        platform: linux32
      collection:
        opt: true

  build-64-debug-gcc6:
    name: "Linux 64 (debug, gcc6)"
    extends: builder_gcc6
    env:
      USE_64: 1
    treeherder:
      build:
        platform: linux64
      collection:
        debug: true

  build-64-opt-gcc6:
    name: "Linux 64 (opt, gcc6)"
    extends: builder_gcc6
    env:
      BUILD_OPT: 1
      USE_64: 1
    treeherder:
      build:
        platform: linux64
      collection:
        opt: true

  ## Clang 3.8 ################################################################

  build-32-debug-clang:
    name: "Linux 32 (debug, clang)"
    extends: builder_clang
    treeherder:
      build:
        platform: linux32
      collection:
        debug: true

  build-32-opt-clang:
    name: "Linux 32 (opt, clang)"
    extends: builder_clang
    env:
      BUILD_OPT: 1
    treeherder:
      build:
        platform: linux32
      collection:
        opt: true

  build-64-debug-clang:
    name: "Linux 64 (debug, clang)"
    extends: builder_clang
    env:
      USE_64: 1
    treeherder:
      build:
        platform: linux64
      collection:
        debug: true

  build-64-opt-clang:
    name: "Linux 64 (opt, clang)"
    extends: builder_clang
    env:
      BUILD_OPT: 1
      USE_64: 1
    treeherder:
      build:
        platform: linux64
      collection:
        opt: true

  ## NO_PKCS11_BYPASS=1 #######################################################

  build-32-debug-no-pkcs11-bypass:
    name: "Linux 32 (debug, NO_PKCS11_BYPASS=1)"
    extends: builder_no_pkcs11_bypass
    treeherder:
      build:
        platform: linux32
      collection:
        debug: true

  build-32-opt-no-pkcs11-bypass:
    name: "Linux 32 (opt, NO_PKCS11_BYPASS=1)"
    extends: builder_no_pkcs11_bypass
    env:
      BUILD_OPT: 1
    treeherder:
      build:
        platform: linux32
      collection:
        opt: true

  build-64-debug-no-pkcs11-bypass:
    name: "Linux 64 (debug, NO_PKCS11_BYPASS=1)"
    extends: builder_no_pkcs11_bypass
    env:
      USE_64: 1
    treeherder:
      build:
        platform: linux64
      collection:
        debug: true

  build-64-opt-no-pkcs11-bypass:
    name: "Linux 64 (opt, NO_PKCS11_BYPASS=1)"
    extends: builder_no_pkcs11_bypass
    env:
      BUILD_OPT: 1
      USE_64: 1
    treeherder:
      build:
        platform: linux64
      collection:
        opt: true

  ## NSS_ENABLE_TLS_1_3=0 #####################################################

  build-32-debug-no-tls-13:
    name: "Linux 32 (debug, no TLS 1.3)"
    extends: builder_no_tls_1_3
    treeherder:
      build:
        platform: linux32
      collection:
        debug: true

  build-32-opt-no-tls-13:
    name: "Linux 32 (opt, no TLS 1.3)"
    extends: builder_no_tls_1_3
    env:
      BUILD_OPT: 1
    treeherder:
      build:
        platform: linux32
      collection:
        opt: true

  build-64-debug-no-tls-13:
    name: "Linux 64 (debug, no TLS 1.3)"
    extends: builder_no_tls_1_3
    env:
      USE_64: 1
    treeherder:
      build:
        platform: linux64
      collection:
        debug: true

  build-64-opt-no-tls-13:
    name: "Linux 64 (opt, no TLS 1.3)"
    extends: builder_no_tls_1_3
    env:
      BUILD_OPT: 1
      USE_64: 1
    treeherder:
      build:
        platform: linux64
      collection:
        opt: true

  ## Tools ####################################################################

  clang-format:
    name: "clang-format-3.8"
    command:
      - "/bin/bash"
      - "-c"
      - "bin/checkout.sh && nss/automation/taskcluster/scripts/run_clang_format.sh nss/lib/ssl"
    treeherder:
      symbol: clang-format
      build:
        platform: nss-tools
